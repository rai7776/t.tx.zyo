<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英単語学習アプリ v7.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');

        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-color: #f4f7f6;
            --border-color: #dee2e6;
        }
        
        body {
            font-family: 'M PLUS Rounded 1c', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--dark-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 16px;
        }
        
        body.explosion { animation: shake-hard 0.8s cubic-bezier(.36,.07,.19,.97) both; }

        .container { max-width: 600px; width: 100%; background: #fff; padding: 20px 30px 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); margin-top: 60px; position: relative; }
        #home-button, #reset-button { position: absolute; top: -50px; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.2s ease; }
        #home-button { left: 0; background-color: #fff; color: var(--dark-color); border: 1px solid var(--border-color); }
        #home-button:hover { background-color: var(--light-color); transform: translateY(-2px); }
        #reset-button { right: 0; width: 45px; height: 45px; padding: 0; background-color: var(--danger-color); color: white; border: 1px solid var(--danger-color); font-size: 1.5em; display: flex; align-items: center; justify-content: center; }
        #reset-button:hover { background-color: #c82333; transform: translateY(-2px); }
        #reset-button:active { transform: scale(0.9); }

        h1, h2, h3 { text-align: center; }
        h1 { color: var(--dark-color); margin: 10px 0 20px; }
        h2 { color: var(--dark-color); margin-bottom: 20px; font-size: 1.5em; border-bottom: 2px solid var(--light-color); padding-bottom: 10px; }
        h3 { font-size: 1.2em; color: var(--dark-color); margin-bottom: 15px; }

        .home-menu-buttons { display: flex; flex-direction: column; gap: 15px; padding: 20px 0; }
        .home-menu-buttons button { padding: 20px; font-size: 1.3em; font-weight: bold; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; width: 100%; border: 2px solid var(--border-color); background-color: #fff; color: var(--dark-color); }
        .home-menu-buttons button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); border-color: var(--primary-color); }
        .home-menu-buttons button:disabled { opacity: 0.5; cursor: not-allowed; }
        #new-start-quiz-btn { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        #new-start-quiz-btn:hover:not(:disabled) { background-color: #218838; border-color: #1e7e34;}
        #new-start-review-quiz-btn { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        #new-start-review-quiz-btn:hover:not(:disabled) { background-color: #c82333; border-color: #bd2130;}

        .content { display: none; }
        .content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .view-toggle { text-align: center; margin-bottom: 20px; }
        .view-btn { padding: 8px 16px; border: 1px solid var(--border-color); background: white; cursor: pointer; border-radius: 5px; font-size: 0.9em; }
        .view-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .view { display: none; }
        .view.active { display: block; }
        
        .word-cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding: 10px 0; }
        .word-card { height: 100px; background-color: transparent; cursor: pointer; perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 10px; }
        .word-card.flipped .card-inner { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 1.1em; font-weight: bold; padding: 5px; box-sizing: border-box; text-align: center; }
        .card-front { background-color: white; border: 1px solid var(--border-color); color: var(--dark-color); }
        .card-back { background-color: var(--primary-color); color: white; transform: rotateY(180deg); }

        #word-list-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #word-list-table th, #word-list-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        #word-list-table th { background-color: var(--light-color); }

        .setting-section { margin-top: 20px; }
        .setting-item { display: flex; justify-content: center; align-items: center; margin-bottom: 25px; }
        .setting-label { font-size: 1.1em; font-weight: bold; margin-right: 15px; }
        #num-questions { padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 80px; font-size: 1em; text-align: center; }
        
        .mode-switch { display: flex; align-items: center; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; margin: 0 15px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .layout-selector { display: flex; justify-content: center; gap: 10px; }
        .layout-btn { flex: 1; max-width: 100px; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background-color: white; font-size: 1em; cursor: pointer; }
        .layout-btn.active { border-color: var(--primary-color); background-color: #e7f1ff; font-weight: bold; }
        #back-to-home-btn { padding: 12px 25px; background: var(--secondary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; margin-top: 20px; width: 100%; }

        #quiz-container { text-align: center; position: relative; min-height: 350px; }
        #question-word { font-size: clamp(2.5rem, 8vw, 4rem); margin-bottom: 20px; font-weight: 700; }
        .answer-buttons { display: grid; gap: 15px; margin-bottom: 20px; }
        #quiz-area.layout-vertical .answer-buttons { grid-template-columns: 1fr; }
        #quiz-area.layout-horizontal .answer-buttons { grid-template-columns: 1fr 1fr; }
        
        .answer-button { padding: 18px; font-size: 1.3em; font-weight: bold; background-color: #fff; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
        .answer-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .answer-button:disabled { cursor: not-allowed; opacity: 0.8; }
        .correct-answer { border-color: var(--success-color) !important; background-color: #e8f5e9 !important; transform: scale(1.05); }
        .wrong-answer { border-color: var(--danger-color) !important; background-color: #ffebee !important; animation: shake 0.5s; }
        @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }
        
        #explanation { margin-top: 15px; padding: 15px; border-radius: 8px; font-size: 1.05em; min-height: 50px; opacity: 0; transition: opacity 0.4s; }
        #explanation.show { opacity: 1; }
        #explanation.correct { background-color: #e8f5e9; color: #1c5c20; }
        #explanation.incorrect { background-color: #ffebee; color: #b71c1c; }
        
        #quiz-finished { padding: 20px 0; }
        #final-score { font-size: 1.5em; font-weight: bold; }
        .result-buttons { margin-top: 25px; text-align: center; }
        .result-buttons button { background: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; margin: 5px; transition: all 0.2s ease; }
        .result-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #start-mistake-quiz-btn { background-color: var(--danger-color); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content { background: white; padding: 30px 40px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transform: scale(0.7); transition: transform 0.3s ease; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content p { font-size: 1.2em; margin: 0 0 20px; font-weight: bold; }
        .modal-content button { padding: 10px 30px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
        .particle { position: absolute; border-radius: 50%; pointer-events: none; z-index: 1000; }
        
        #special-trigger-container { position: fixed; bottom: 15px; right: 15px; display: flex; gap: 10px; z-index: 1999; }
        #special-trigger-container button { font-size: 2rem; background: none; border: none; cursor: pointer; transition: transform 0.2s; padding: 0; }
        #special-trigger-container button:hover { transform: scale(1.2); }

        #special-mode { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 2100; }
        #fireworks-canvas { display: block; width: 100%; height: 100%; }
        #special-home-btn { position: absolute; top: 20px; left: 20px; padding: 10px 20px; background: rgba(255, 255, 255, 0.8); color: #000; border: 1px solid #000; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; }
        
        #special-mode-v2 { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 2100; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #canvas-container canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #background-canvas-v2 { z-index: 1; }
        #fireworks-canvas-v2 { z-index: 2; }
        #foreground-canvas-v2 { z-index: 3; pointer-events: none; }
        #special-mode-ui { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; z-index: 4; pointer-events: none; }
        #special-mode-ui button { pointer-events: all; }
        #special-home-btn-v2 { padding: 10px 20px; background: rgba(255, 255, 255, 0.8); color: #000; border: 1px solid #000; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; }
        #meaning-btn { font-size: 2rem; background: none; border: none; cursor: pointer; transition: transform 0.2s; padding: 0; position: absolute; left: 50%; transform: translateX(-50%); }
        #meaning-btn:hover { transform: translateX(-50%) scale(1.2); }
        #tap-counter { color: white; font-size: 1.5em; font-weight: bold; text-shadow: 0 0 5px black; }
        
        #meaning-display {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 0 0 10px #ff0;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            box-sizing: border-box;
            width: 80%;
            max-width: 800px;
            text-align: center;
        }
        #meaning-display.show { opacity: 1; }

        /* ▼▼▼【新規追加】単語管理パネルのスタイル ▼▼▼ */
        #word-management-panel {
            border-top: 2px solid var(--border-color);
            margin-top: 40px;
            padding-top: 20px;
        }
        .management-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--light-color);
        }
        .management-section h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .management-section input[type="text"],
        .management-section input[type="search"],
        .management-section input[type="file"] {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .management-section button {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: background-color 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .management-section .btn-primary { background-color: var(--primary-color); color: white; }
        .management-section .btn-primary:hover { background-color: #0056b3; }
        .management-section .btn-secondary { background-color: var(--secondary-color); color: white; }
        .management-section .btn-secondary:hover { background-color: #5a6268; }
        .management-section .btn-danger { background-color: var(--danger-color); color: white; }
        .management-section .btn-danger:hover { background-color: #c82333; }
        .management-section a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9em;
            margin-right: 15px;
        }
        .management-section a:hover { text-decoration: underline; }
        #management-word-list-container { max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; background: white; }
        #management-word-list-container ul { list-style: none; padding: 0; margin: 0; }
        #management-word-list-container li { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        #management-word-list-container li:last-child { border-bottom: none; }
        #management-word-list-container li label { flex-grow: 1; }
        #management-word-list-container .delete-card-btn { font-size: 0.8em; padding: 4px 8px; }
        /* ▲▲▲【新規追加】単語管理パネルのスタイル ▲▲▲ */

    </style>
</head>
<body>

    <div class="container">
        <button id="home-button">ホーム</button>
        <button id="reset-button" title="押すなよ？">💣</button>
        
        <div id="main-content">
            <div id="home" class="content active">
                <h1>英単語学習</h1>
                <div class="home-menu-buttons">
                    <button id="new-show-wordbook-btn">単語帳をみる</button>
                    <button id="new-start-quiz-btn">テストを始める</button>
                    <button id="new-start-review-quiz-btn">復習テスト開始</button>
                    <button id="new-show-settings-btn">テスト設定</button>
                </div>
                
                <div id="word-management-panel">
                    <h2>単語管理</h2>
                    <div class="management-section">
                        <h3>登録単語一覧</h3>
                        <input type="search" id="search-box" placeholder="登録単語を検索...">
                        <div id="management-word-list-container"></div>
                        <button id="delete-selected-btn" class="btn-danger">選択した単語を削除</button>
                    </div>

                    <div class="management-section">
                        <h3>単語の新規追加</h3>
                        <input type="text" id="add-word-input" placeholder="英単語" required>
                        <input type="text" id="add-meaning-input" placeholder="主な意味" required>
                        <input type="text" id="add-usage-input" placeholder="用法 (例: to do, ~ing)" required>
                        <input type="text" id="add-explanation-input" placeholder="解説" required>
                        <button id="add-word-btn" class="btn-primary">手動で追加</button>
                    </div>

                    <div class="management-section">
                        <h3>一括インポート・エクスポート</h3>
                        <p style="font-size:0.9em; margin-top:0;">CSVまたはExcel(xlsx)ファイルで単語を一括登録できます。</p>
                        <input type="file" id="import-file-input" accept=".csv, .xlsx">
                        <button id="import-btn" class="btn-primary">インポート実行</button>
                        <br>
                        <a id="download-csv-template" href="#">雛形(CSV)ダウンロード</a>
                        <a id="download-excel-template" href="#">雛形(Excel)ダウンロード</a>
                        <br><br>
                        <button id="export-csv-btn" class="btn-secondary">全単語をCSVでエクスポート</button>
                        <button id="export-excel-btn" class="btn-secondary">全単語をExcelでエクスポート</button>
                    </div>
                </div>
                </div>

            <div id="wordbook" class="content">
                <h2>単語帳</h2>
                <div class="view-toggle">
                    <button id="card-view-btn" class="view-btn active">カード</button>
                    <button id="list-view-btn" class="view-btn">一覧</button>
                </div>
                <div id="card-view" class="view active">
                    <div class="word-cards-container"></div>
                </div>
                <div id="list-view" class="view">
                    <table id="word-list-table">
                        <thead><tr><th>英単語</th><th>用法</th><th>主な意味</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="settings" class="content">
                <h2>テスト設定</h2>
                <div class="setting-section">
                    <div class="setting-item">
                        <span class="setting-label">出題バランス:</span>
                        <div class="mode-switch">
                            <span>ランダム</span>
                            <label class="switch">
                                <input type="checkbox" id="balance-mode-toggle">
                                <span class="slider round"></span>
                            </label>
                            <span>バランス</span>
                        </div>
                    </div>
                     <div class="setting-item">
                        <span class="setting-label">ボタン配置:</span>
                        <div class="layout-selector">
                            <button class="layout-btn" data-layout="vertical">縦</button>
                            <button class="layout-btn" data-layout="horizontal">横</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label" for="num-questions">出題数:</label>
                        <input type="number" id="num-questions" value="10" min="1">
                    </div>
                </div>
                <button id="back-to-home-btn">ホームに戻る</button>
            </div>
            
            <div id="quiz-area" class="content">
                <div id="quiz-container"></div>
            </div>

            <div id="quiz-finished" class="content">
                 <h2 id="result-title">テスト完了！</h2>
                <p id="final-score"></p>
                <div id="mistakes-list" style="display: none;">
                    <h3>間違えた問題</h3>
                    <ul id="mistakes"></ul>
                </div>
                <div class="result-buttons">
                    <button id="start-mistake-quiz-btn">間違えた問題だけ復習</button>
                    <button id="go-to-home-btn">ホームに戻る</button>
                </div>
            </div>
        </div>
    </div>

    <div id="unsupported-modal" class="modal-overlay">
        <div class="modal-content">
            <p>この機能はiPhoneのせいで使えません。</p>
            <button id="close-modal-btn">OK</button>
        </div>
    </div>
    
    <div id="special-trigger-container">
        <button title="りんご">🍎</button>
        <button id="grape-btn" title="ぶどう">🍇</button>
        <button id="cherry-btn" title="さくらんぼ">🍒</button>
    </div>

    <div id="special-mode" style="display: none;">
        <button id="special-home-btn">ホームに戻る</button>
        <canvas id="fireworks-canvas"></canvas>
    </div>

    <div id="special-mode-v2" style="display: none;">
        <div id="canvas-container">
            <canvas id="background-canvas-v2"></canvas>
            <canvas id="fireworks-canvas-v2"></canvas>
            <canvas id="foreground-canvas-v2"></canvas>
        </div>
        <div id="special-mode-ui">
            <button id="special-home-btn-v2">ホーム</button>
            <button id="meaning-btn">🍒</button>
            <div id="tap-counter">Taps: 0</div>
        </div>
        <div id="meaning-display"></div>
    </div>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script>
        // ▼▼▼【変更】wordDataをletに変更し、初期データは関数内で定義▼▼▼
        let wordData = []; 
        
        function getInitialWordData() {
            return [
                { id: 1, word: 'agree', usage: 'to do', meaning: '同意する', explanation: '「これから～すること」に同意するという未来志向の動詞です。' },
                { id: 2, word: 'decide', usage: 'to do', meaning: '決心する', explanation: '「これから～する」と未来の行動を決めるため、to不定詞をとります。' },
                { id: 3, word: 'expect', usage: 'to do', meaning: '予期する', explanation: '「これから～だろう」と未来を予期するため、to不定詞が合います。' },
                { id: 4, word: 'want', usage: 'to do', meaning: '欲する', explanation: '「これから～したい」という未来への願望を表す代表的な動詞です。' },
                { id: 5, word: 'wish', usage: 'to do', meaning: '願う', explanation: '「～できたらなあ」という未来への願いを表します。' },
                { id: 6, word: 'hope', usage: 'to do', meaning: '希望する', explanation: '「～になること」を望む、未来への希望を表します。' },
                { id: 7, word: 'promise', usage: 'to do', meaning: '約束する', explanation: '「これから～する」と未来の行動を約束します。' },
                { id: 8, word: 'plan', usage: 'to do', meaning: '計画する', explanation: '「これから～する」ための計画を立てる動詞です。' },
                { id: 9, word: 'offer', usage: 'to do', meaning: '申し出る', explanation: '「（私が）～しましょう」と未来の行動を申し出ます。' },
                { id: 10, word: 'mean', usage: 'to do', meaning: '意図する', explanation: '「～するつもり」という未来の意図を表します。' },
                { id: 11, word: 'refuse', usage: 'to do', meaning: '拒否する', explanation: '「これから～すること」を拒否するという意志を表します。' },
                { id: 12, word: 'manage', usage: 'to do', meaning: 'なんとかやり遂げる', explanation: '困難な状況で「～すること」をなんとか成し遂げる、という達成を表します。' },
                { id: 13, word: 'admit', usage: '~ing', meaning: '認める', explanation: '「（過去に）～したこと」を認める、という経験や事実に関する動詞です。' },
                { id: 14, word: 'deny', usage: '~ing', meaning: '否定する', explanation: '「（過去に）～したこと」を否定する、という経験や事実に関する動詞です。' },
                { id: 15, word: 'consider', usage: '~ing', meaning: '熟考する', explanation: '「～すること」を頭の中でじっくり考える、思考活動を表します。' },
                { id: 16, word: 'imagine', usage: '~ing', meaning: '想像する', explanation: '「～している場面」を心に思い描く、イメージの動詞です。' },
                { id: 17, word: 'enjoy', usage: '~ing', meaning: '楽しむ', explanation: '「～していること」という行為そのものを楽しむ、経験の動詞です。' },
                { id: 18, word: 'finish', usage: '~ing', meaning: '終える', explanation: '「～していたこと」を終える、継続していた行為の完了を表します。' },
                { id: 19, word: 'give up', usage: '~ing', meaning: 'あきらめる', explanation: '「～すること」をやめる、継続していた行為の中断を表します。' },
                { id: 20, word: 'avoid', usage: '~ing', meaning: '避ける', explanation: '「～すること」という行為を避ける、反復的なニュアンスも持ちます。' },
                { id: 21, word: 'mind', usage: '~ing', meaning: '気にする、嫌がる', explanation: '「～すること」を嫌がる、という感情を表します。(Do you mind ~ing?)' },
                { id: 22, word: 'practice', usage: '~ing', meaning: '練習する', explanation: '「～すること」を繰り返し練習する、反復行為を表します。' },
                { id: 23, word: 'suggest', usage: '~ing', meaning: '提案する', explanation: '「～してはどうか」とある行為を提案します。' }
            ];
        }

        let currentQuiz = [], currentQuestionIndex = 0, incorrectQuestions = [], savedMistakes = [];
        let appState = { view: 'home', isQuizActive: false };
        let answerTimer;
        const NEXT_QUESTION_DELAY = 1000;
        let isPracticeMode = false; 

        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                container: document.querySelector('.container'),
                mainContent: document.getElementById('main-content'),
                homeButton: document.getElementById('home-button'),
                resetButton: document.getElementById('reset-button'),
                newShowWordbookBtn: document.getElementById('new-show-wordbook-btn'),
                newStartQuizBtn: document.getElementById('new-start-quiz-btn'),
                newStartReviewQuizBtn: document.getElementById('new-start-review-quiz-btn'),
                newShowSettingsBtn: document.getElementById('new-show-settings-btn'),
                backToHomeBtn: document.getElementById('back-to-home-btn'),
                cardViewBtn: document.getElementById('card-view-btn'),
                listViewBtn: document.getElementById('list-view-btn'),
                startMistakeQuizBtn: document.getElementById('start-mistake-quiz-btn'),
                goToHomeBtn: document.getElementById('go-to-home-btn'),
                unsupportedModal: document.getElementById('unsupported-modal'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                layoutBtns: document.querySelectorAll('.layout-btn'),
                wordCardsContainer: document.querySelector('.word-cards-container'),
                grapeBtn: document.getElementById('grape-btn'),
                cherryBtn: document.getElementById('cherry-btn'),
                specialMode: document.getElementById('special-mode'),
                specialHomeBtn: document.getElementById('special-home-btn'),
                fireworksCanvas: document.getElementById('fireworks-canvas'),
                specialModeV2: document.getElementById('special-mode-v2'),
                specialHomeBtnV2: document.getElementById('special-home-btn-v2'),
                backgroundCanvasV2: document.getElementById('background-canvas-v2'),
                fireworksCanvasV2: document.getElementById('fireworks-canvas-v2'),
                foregroundCanvasV2: document.getElementById('foreground-canvas-v2'),
                meaningBtn: document.getElementById('meaning-btn'),
                tapCounter: document.getElementById('tap-counter'),
                meaningDisplay: document.getElementById('meaning-display'),
                // ▼▼▼【新規追加】管理パネルの要素 ▼▼▼
                searchBox: document.getElementById('search-box'),
                managementWordListContainer: document.getElementById('management-word-list-container'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'),
                addWordInput: document.getElementById('add-word-input'),
                addMeaningInput: document.getElementById('add-meaning-input'),
                addUsageInput: document.getElementById('add-usage-input'),
                addExplanationInput: document.getElementById('add-explanation-input'),
                addWordBtn: document.getElementById('add-word-btn'),
                importFileInput: document.getElementById('import-file-input'),
                importBtn: document.getElementById('import-btn'),
                downloadCsvTemplate: document.getElementById('download-csv-template'),
                downloadExcelTemplate: document.getElementById('download-excel-template'),
                exportCsvBtn: document.getElementById('export-csv-btn'),
                exportExcelBtn: document.getElementById('export-excel-btn'),
            };
            
            // ▼▼▼【新規追加】データ読み込み ▼▼▼
            loadWordData();

            elements.homeButton.addEventListener('click', showHome);
            elements.resetButton.addEventListener('click', triggerExplosionEffect);
            elements.newShowWordbookBtn.addEventListener('click', () => showContent('wordbook'));
            elements.newStartQuizBtn.addEventListener('click', () => { isPracticeMode = false; startQuiz(wordData); });
            elements.newStartReviewQuizBtn.addEventListener('click', startReviewQuizFromHome);
            elements.newShowSettingsBtn.addEventListener('click', () => showContent('settings'));
            elements.backToHomeBtn.addEventListener('click', showHome);
            elements.cardViewBtn.addEventListener('click', () => toggleWordbookView(true));
            elements.listViewBtn.addEventListener('click', () => toggleWordbookView(false));
            elements.startMistakeQuizBtn.addEventListener('click', startMistakeQuiz);
            elements.goToHomeBtn.addEventListener('click', showHome);
            elements.closeModalBtn.addEventListener('click', () => elements.unsupportedModal.classList.remove('show'));
            elements.layoutBtns.forEach(btn => btn.addEventListener('click', () => applyLayout(btn.dataset.layout)));
            elements.wordCardsContainer.addEventListener('click', (event) => {
                const card = event.target.closest('.word-card');
                if (card) {
                    card.classList.toggle('flipped');
                }
            });

            let grapeClickCount = 0;
            elements.grapeBtn.addEventListener('click', () => {
                grapeClickCount++;
                if (grapeClickCount >= 5) {
                    grapeClickCount = 0;
                    startSpecialMode(elements);
                }
            });
            elements.specialHomeBtn.addEventListener('click', () => endSpecialMode(elements));

            let cherryClickCount = 0;
            elements.cherryBtn.addEventListener('click', () => {
                cherryClickCount++;
                if (cherryClickCount >= 5) {
                    cherryClickCount = 0;
                    startSpecialModeV2(elements);
                }
            });
            elements.specialHomeBtnV2.addEventListener('click', () => endSpecialModeV2(elements));
            
            // ▼▼▼【新規追加】管理パネルのイベントリスナー ▼▼▼
            elements.searchBox.addEventListener('input', () => renderManagementWordList());
            elements.addWordBtn.addEventListener('click', addNewWord);
            elements.managementWordListContainer.addEventListener('click', handleManagementListClick);
            elements.deleteSelectedBtn.addEventListener('click', deleteSelectedWords);
            elements.importBtn.addEventListener('click', () => handleImport(elements.importFileInput));
            elements.exportCsvBtn.addEventListener('click', exportToCsv);
            elements.exportExcelBtn.addEventListener('click', exportToExcel);
            elements.downloadCsvTemplate.addEventListener('click', downloadTemplateCsv);
            elements.downloadExcelTemplate.addEventListener('click', downloadTemplateExcel);

            loadLayout();
            loadMistakes();
            updateAllViews();
            showHome();
        });
        
        // ▼▼▼【新規追加】データのロードとセーブ機能 ▼▼▼
        function loadWordData() {
            const savedData = localStorage.getItem("wordData_v7.0");
            if (savedData) {
                wordData = JSON.parse(savedData);
            } else {
                wordData = getInitialWordData();
            }
        }

        function saveWordData() {
            localStorage.setItem("wordData_v7.0", JSON.stringify(wordData));
        }

        function updateAllViews() {
            updateHomePage();
            generateWordCards();
            generateWordListTable();
            renderManagementWordList();
            // テスト設定の最大出題数を更新
            const numQuestionsInput = document.getElementById('num-questions');
            if (numQuestionsInput) {
                numQuestionsInput.max = wordData.length > 0 ? wordData.length : 1;
                if (parseInt(numQuestionsInput.value) > wordData.length && wordData.length > 0) {
                    numQuestionsInput.value = wordData.length;
                }
            }
        }
        
        function loadMistakes(){try{const e=localStorage.getItem("savedMistakes_v5.3");savedMistakes=e?JSON.parse(e):[],Array.isArray(savedMistakes)||(savedMistakes=[])}catch(e){console.error("Failed to load mistakes:",e),savedMistakes=[]}}
        function saveMistakes(){localStorage.setItem("savedMistakes_v5.3",JSON.stringify(savedMistakes))}
        function triggerExplosionEffect(){const e=document.getElementById("reset-button"),t=e.getBoundingClientRect();document.body.classList.add("explosion");for(let o=0;o<50;o++)createParticle(t.left+t.width/2,t.top+t.height/2);setTimeout(()=>{document.body.classList.remove("explosion"),document.getElementById("unsupported-modal").classList.add("show")},1e3)}
        function createParticle(e,t){const o=document.createElement("div");o.className="particle",document.body.appendChild(o);const a=Math.floor(15*Math.random()+5);o.style.width=`${a}px`,o.style.height=`${a}px`,o.style.background=`hsl(${60*Math.random()}, 100%, 50%)`;const n=e+(.5-Math.random())*2*(window.innerWidth/3),s=t+(.5-Math.random())*2*(window.innerHeight/3);o.style.left=`${e-a/2}px`,o.style.top=`${t-a/2}px`;o.animate([{transform:"translate(0, 0)",opacity:1},{transform:`translate(${n-e}px, ${s-t}px)`,opacity:0}],{duration:1e3*Math.random()+800,easing:"cubic-bezier(0, .9, .57, 1)"}).onfinish=()=>{o.remove()}}
        function applyLayout(layout) { document.getElementById('quiz-area').className = `content layout-${layout}`; localStorage.setItem('layout_v5.3', layout); document.querySelectorAll('.layout-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.layout === layout); }); }
        function loadLayout() { const savedLayout = localStorage.getItem('layout_v5.3') || 'vertical'; applyLayout(savedLayout); }
        function updateHomePage() { const reviewBtn = document.getElementById('new-start-review-quiz-btn'); reviewBtn.disabled = savedMistakes.length === 0; reviewBtn.textContent = `復習テスト開始 (${savedMistakes.length}問)`; }
        
        // ▼▼▼【修正】① 絵文字ボタン表示制御を追加 ▼▼▼
        function showContent(contentId) { 
            clearTimeout(answerTimer); 
            appState.view = contentId; 
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active')); 
            const newContent = document.getElementById(contentId); 
            if (newContent) newContent.classList.add('active'); 
            
            // ホーム画面なら絵文字ボタンを表示、それ以外は非表示
            const specialTriggers = document.getElementById('special-trigger-container');
            if (contentId === 'home') {
                specialTriggers.style.display = 'flex';
            } else {
                specialTriggers.style.display = 'none';
            }
        }

        function showHome() { appState.isQuizActive = false; updateHomePage(); showContent('home'); }
        function generateWordCards() { const container = document.querySelector('.word-cards-container'); container.innerHTML = ''; wordData.forEach(item => { container.innerHTML += `<div class="word-card"><div class="card-inner"><div class="card-face card-front">${item.word}</div><div class="card-face card-back">${item.meaning}</div></div></div>`; }); }
        function generateWordListTable() { const tbody = document.querySelector('#word-list-table tbody'); tbody.innerHTML = ''; wordData.forEach(item => { tbody.innerHTML += `<tr><td>${item.word}</td><td>${item.usage}</td><td>${item.meaning}</td></tr>`; }); }
        function toggleWordbookView(showCards) { document.getElementById('card-view').classList.toggle('active', showCards); document.getElementById('card-view-btn').classList.toggle('active', showCards); document.getElementById('list-view').classList.toggle('active', !showCards); document.getElementById('list-view-btn').classList.toggle('active', !showCards); }
        function startQuiz(sourceData) { if (sourceData.length === 0) { alert("出題できる単語がありません。"); return; } appState.isQuizActive = true; document.getElementById('quiz-container').innerHTML = ''; let num = isPracticeMode ? sourceData.length : parseInt(document.getElementById('num-questions').value, 10); if (num > sourceData.length) num = sourceData.length; const isBalanceMode = document.getElementById('balance-mode-toggle').checked; if (isBalanceMode && !isPracticeMode) { const toDoWords = wordData.filter(w => w.usage === 'to do').sort(() => 0.5 - Math.random()); const ingWords = wordData.filter(w => w.usage === '~ing').sort(() => 0.5 - Math.random()); const numToDo = Math.ceil(num / 2); const numIng = num - numToDo; currentQuiz = [...toDoWords.slice(0, numToDo), ...ingWords.slice(0, numIng)].sort(() => 0.5 - Math.random()); } else { currentQuiz = [...sourceData].sort(() => 0.5 - Math.random()).slice(0, num); } currentQuestionIndex = 0; incorrectQuestions = []; showContent('quiz-area'); drawNewQuestion(); }
        function startReviewQuizFromHome(){if(savedMistakes.length===0)return;isPracticeMode=!0,startQuiz(savedMistakes)}
        function startMistakeQuiz(){if(incorrectQuestions.length===0)return;isPracticeMode=!0;const e=[...new Set(incorrectQuestions.map(JSON.stringify))].map(JSON.parse);startQuiz(e)}
        function drawNewQuestion() { if (!appState.isQuizActive) return; if (currentQuestionIndex >= currentQuiz.length) { showQuizResult(); return; } const questionData = currentQuiz[currentQuestionIndex]; const container = document.getElementById('quiz-container'); container.innerHTML = `<div class="question-area"><div id="question-word">${questionData.word}</div><div class="answer-buttons"><button class="answer-button">to do</button><button class="answer-button">~ing</button></div><div id="explanation"></div></div>`; const buttons = container.querySelectorAll('.answer-buttons button'); buttons[0].addEventListener('click', () => checkAnswer('to do', buttons[0])); buttons[1].addEventListener('click', () => checkAnswer('~ing', buttons[1])); }
        function checkAnswer(selectedUsage, clickedButton) { if (!appState.isQuizActive) return; clearTimeout(answerTimer); const questionData = currentQuiz[currentQuestionIndex]; const correctAnswer = questionData.usage; const buttons = document.querySelectorAll('.answer-buttons button'); const explanationEl = document.getElementById('explanation'); buttons.forEach(btn => btn.disabled = true); if (selectedUsage === correctAnswer) { clickedButton.classList.add('correct-answer'); explanationEl.innerHTML = `<b>正解！</b> ${questionData.explanation}`; explanationEl.className = 'correct'; if (isPracticeMode) { savedMistakes = savedMistakes.filter(item => item.id !== questionData.id); saveMistakes(); } } else { clickedButton.classList.add('wrong-answer'); incorrectQuestions.push(questionData); buttons.forEach((btn, index) => { if ((index === 0 && correctAnswer === 'to do') || (index === 1 && correctAnswer === '~ing')) btn.classList.add('correct-answer'); }); explanationEl.innerHTML = `<b>不正解...</b> 正しくは <b>${correctAnswer}</b>。<br>${questionData.explanation}`; explanationEl.className = 'incorrect'; if (!savedMistakes.some(item => item.id === questionData.id)) { savedMistakes.push(questionData); saveMistakes(); } } explanationEl.classList.add('show'); currentQuestionIndex++; answerTimer = setTimeout(drawNewQuestion, NEXT_QUESTION_DELAY + 1000); }
        function showQuizResult() { appState.isQuizActive = false; const score = currentQuiz.length - incorrectQuestions.length; document.getElementById('final-score').textContent = `正解数: ${score} / ${currentQuiz.length}`; const mistakesList = document.getElementById('mistakes-list'); const mistakesUl = document.getElementById('mistakes'); const mistakeQuizBtn = document.getElementById('start-mistake-quiz-btn'); const uniqueMistakes = [...new Set(incorrectQuestions.map(JSON.stringify))].map(JSON.parse); mistakeQuizBtn.style.display = uniqueMistakes.length > 0 ? 'inline-block' : 'none'; mistakesList.style.display = uniqueMistakes.length > 0 ? 'block' : 'none'; if (uniqueMistakes.length > 0) { mistakesUl.innerHTML = ''; uniqueMistakes.forEach(item => { mistakesUl.innerHTML += `<li>${item.word} (正解: ${item.usage})</li>`; }); } document.getElementById('result-title').textContent = (score === currentQuiz.length) ? "全問正解！おめでとうございます！" : "テスト完了！"; showContent('quiz-finished'); }
        
        let fireworksAnimationId;
        function startSpecialMode(elements) {
            elements.container.style.display = 'none';
            elements.specialMode.style.display = 'block';
            const canvas = elements.fireworksCanvas;
            const ctx = canvas.getContext('2d');
            let particles = [];
            let stars = [];
            function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; stars = []; drawStars(); }
            function drawStars() { if (stars.length === 0) { for (let i = 0; i < 100; i++) { stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, radius: Math.random() * 1.5, alpha: Math.random() * 0.5 + 0.5 }); } } ctx.fillStyle = '#FFF'; stars.forEach(star => { ctx.save(); ctx.globalAlpha = star.alpha; ctx.beginPath(); ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2); ctx.fill(); ctx.restore(); }); }
            function launchFirework(e) { const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; const randomWord = wordData[Math.floor(Math.random() * wordData.length)].word; const hue = Math.random() * 360; const launchParticle = { x: canvas.width / 2, y: canvas.height, tx: x, ty: y, speed: 3, angle: Math.atan2(y - canvas.height, x - canvas.width / 2), hue: hue, brightness: 50, alpha: 1, decay: 0.98, word: randomWord, update: function() { this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed; this.speed *= this.decay; }, draw: function() { ctx.save(); ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fillStyle = `hsl(${this.hue}, 100%, ${this.brightness}%)`; ctx.fill(); ctx.restore(); } }; particles.push(launchParticle); }
            function createExplosion(x, y, hue, word) { particles.push(new TextParticle(x, y, hue, word)); const particleCount = 100; for(let i = 0; i < particleCount; i++) { particles.push(new Particle(x, y, hue)); } }
            class Particle { constructor(x, y, hue) { this.x = x; this.y = y; this.angle = Math.random() * Math.PI * 2; this.speed = Math.random() * 8 + 1; this.friction = 0.97; this.gravity = 0.05; this.hue = Math.random() * 20 + hue - 10; this.brightness = Math.random() * 30 + 50; this.alpha = 1; this.decay = Math.random() * 0.03 + 0.01; } update() { this.speed *= this.friction; this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed + this.gravity; this.alpha -= this.decay; } draw(ctx) { ctx.save(); ctx.globalAlpha = this.alpha; ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fillStyle = `hsl(${this.hue}, 100%, ${this.brightness}%)`; ctx.fill(); ctx.restore(); } }
            class TextParticle extends Particle { constructor(x, y, hue, word) { super(x, y, hue); this.word = word; this.alpha = 1; this.decay = 0.01; this.size = 40; } update() { this.alpha -= this.decay; this.size *= 0.99; } draw(ctx) { ctx.save(); ctx.globalAlpha = this.alpha > 0 ? this.alpha : 0; ctx.fillStyle = `hsl(${this.hue}, 100%, 80%)`; ctx.font = `bold ${this.size}px 'M PLUS Rounded 1c'`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.shadowColor = `hsl(${this.hue}, 100%, 50%)`; ctx.shadowBlur = 15; ctx.fillText(this.word, this.x, this.y); ctx.restore(); } }
            function animate() { fireworksAnimationId = requestAnimationFrame(animate); ctx.fillStyle = 'rgba(0, 0, 0, 0.15)'; ctx.fillRect(0, 0, canvas.width, canvas.height); drawStars(); for(let i = particles.length - 1; i >= 0; i--) { const p = particles[i]; p.update(); p.draw(ctx); if (p.alpha <= 0) { particles.splice(i, 1); } else if (p.speed < 0.5 && p.word) { createExplosion(p.x, p.y, p.hue, p.word); particles.splice(i, 1); } } }
            resizeCanvas(); window.addEventListener('resize', resizeCanvas); canvas.addEventListener('click', launchFirework); animate();
        }
        function endSpecialMode(elements) { cancelAnimationFrame(fireworksAnimationId); elements.specialMode.style.display = 'none'; elements.container.style.display = 'block'; window.removeEventListener('resize', () => {}); elements.fireworksCanvas.removeEventListener('click', () => {}); }

        let fireworksAnimationIdV2, resizeHandlerV2, launchHandlerV2, meaningHandlerV2;
        function drawRooftopV2(ctx, width, height) { ctx.clearRect(0, 0, width, height); const bridgeHeight = 80; ctx.fillStyle = '#111'; ctx.fillRect(0, height - bridgeHeight, width, bridgeHeight); ctx.fillStyle = '#222'; for(let i=0; i< width; i += 15){ ctx.fillRect(i, height - bridgeHeight, 2, bridgeHeight); } }
        function drawBackgroundV2(ctx, width, height) { ctx.clearRect(0, 0, width, height); ctx.fillStyle = '#00001a'; ctx.fillRect(0, 0, width, height); for (let i = 0; i < 150; i++) { ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.8 + 0.2})`; ctx.beginPath(); ctx.arc(Math.random() * width, Math.random() * height * 0.8, Math.random() * 1.5, 0, Math.PI * 2); ctx.fill(); } const buildingColors = ['#1a1a2a', '#2a2a3a', '#0a0a1a']; for (let i = 0; i < width; i += Math.random() * 50 + 20) { const buildingHeight = (Math.random() * height * 0.4) + (height * 0.2); ctx.fillStyle = buildingColors[Math.floor(Math.random() * buildingColors.length)]; ctx.fillRect(i, height - buildingHeight, Math.random() * 40 + 10, buildingHeight); for(let y = height - buildingHeight; y < height; y += 10){ for(let x = i; x < i+30; x += 10){ if(Math.random() > 0.5){ ctx.fillStyle = `rgba(255, 220, 100, ${Math.random() * 0.6})`; ctx.fillRect(x+2, y+2, 4, 4); } } } } }
        
        function startSpecialModeV2(elements) {
            elements.container.style.display = 'none';
            elements.specialModeV2.style.display = 'block';
            const bgCanvas = elements.backgroundCanvasV2, fwCanvas = elements.fireworksCanvasV2, fgCanvas = elements.foregroundCanvasV2;
            const bgCtx = bgCanvas.getContext('2d'), fwCtx = fwCanvas.getContext('2d'), fgCtx = fgCanvas.getContext('2d');
            let particles = [], totalTaps = 0, currentWordObject = null, cssWidth = 0, cssHeight = 0;
            
            const randomWord = wordData.length > 0 ? wordData[Math.floor(Math.random() * wordData.length)] : {word: '単語', meaning: 'words', usage: ''};
            currentWordObject = randomWord;
            elements.meaningDisplay.textContent = `${currentWordObject.word} (${currentWordObject.usage})`;

            resizeHandlerV2 = () => {
                const dpr = window.devicePixelRatio || 1;
                const rect = elements.specialModeV2.getBoundingClientRect();
                cssWidth = rect.width;
                cssHeight = rect.height;
                const canvases = [ { canvas: bgCanvas, ctx: bgCtx }, { canvas: fwCanvas, ctx: fwCtx }, { canvas: fgCanvas, ctx: fgCtx } ];
                canvases.forEach(({ canvas, ctx }) => {
                    canvas.style.width = `${cssWidth}px`;
                    canvas.style.height = `${cssHeight}px`;
                    canvas.width = cssWidth * dpr;
                    canvas.height = cssHeight * dpr;
                    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                    ctx.imageSmoothingEnabled = false;
                });
                drawBackgroundV2(bgCtx, cssWidth, cssHeight);
                drawRooftopV2(fgCtx, cssWidth, cssHeight);
            };

            // ▼▼▼【修正】② 花火のロジックを修正 ▼▼▼
            launchHandlerV2 = (e) => {
                totalTaps++;
                elements.tapCounter.textContent = `Taps: ${totalTaps}`;
                
                const rect = fwCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                // クリック位置に関わらず、爆発Y座標を画面上部25%に固定
                const explosionY = cssHeight * 0.25;

                currentWordObject = wordData.length > 0 ? wordData[Math.floor(Math.random() * wordData.length)] : {word: '単語', meaning: 'words', usage: ''};
                const displayText = `${currentWordObject.word}`; // usageを非表示に
                const hue = Math.random() * 360;
                
                // 意味表示を更新
                elements.meaningDisplay.textContent = displayText;
                elements.meaningDisplay.classList.add('show');


                const launchParticle = { 
                    x: cssWidth / 2, y: cssHeight, tx: x, ty: explosionY, 
                    speed: 3, angle: Math.atan2(explosionY - cssHeight, x - (cssWidth / 2)), 
                    hue: hue, brightness: 50, alpha: 1, decay: 0.98, 
                    word: currentWordObject.meaning, // 爆発時には意味を表示
                    scale: 1.0, 
                    update: function() { this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed; this.speed *= this.decay; }, 
                    draw: function(ctx) { ctx.save(); ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fillStyle = `hsl(${this.hue}, 100%, ${this.brightness}%)`; ctx.fill(); ctx.restore(); } 
                };
                particles.push(launchParticle);
            };
            
            const createExplosion = (x, y, hue, word, scale) => { particles.push(new TextParticle(x, y, hue, word, scale)); const particleCount = 100 * scale; for(let i = 0; i < particleCount; i++) { particles.push(new Particle(x, y, hue, scale)); } };
            class Particle { constructor(x, y, hue, scale = 1) { this.x = x; this.y = y; this.angle = Math.random() * Math.PI * 2; this.speed = (Math.random() * 8 + 1) * scale; this.friction = 0.97; this.gravity = 0.05; this.hue = Math.random() * 20 + hue - 10; this.brightness = Math.random() * 30 + 50; this.alpha = 1; this.decay = Math.random() * 0.03 + 0.01; } update() { this.speed *= this.friction; this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed + this.gravity; this.alpha -= this.decay; } draw(ctx) { ctx.save(); ctx.globalAlpha = this.alpha; ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fillStyle = `hsl(${this.hue}, 100%, ${this.brightness}%)`; ctx.fill(); ctx.restore(); } }
            class TextParticle extends Particle {
                constructor(x, y, hue, word, scale = 1) {
                    super(x, y, hue, scale);
                    this.word = word;
                    this.alpha = 1;
                    this.decay = 0.01;
                    this.size = 30 * scale; // サイズを少し調整
                }
                update() { this.alpha -= this.decay; this.size *= 0.99; }
                draw(ctx) { ctx.save(); ctx.globalAlpha = this.alpha > 0 ? this.alpha : 0; ctx.fillStyle = `hsl(${this.hue}, 100%, 80%)`; ctx.font = `bold ${this.size}px 'M PLUS Rounded 1c'`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.shadowColor = `hsl(${this.hue}, 100%, 50%)`; ctx.shadowBlur = 15; ctx.fillText(this.word, this.x, this.y); ctx.restore(); }
            }
            
            meaningHandlerV2 = () => {
                // このボタンは現在単語表示のトグルとして機能しないため、一旦何もしない
                 elements.meaningDisplay.classList.toggle('show');
            };

            function animate() {
                fireworksAnimationIdV2 = requestAnimationFrame(animate);
                fwCtx.clearRect(0, 0, cssWidth, cssHeight);
                for(let i = particles.length - 1; i >= 0; i--) { const p = particles[i]; p.update(); p.draw(fwCtx); if (p.alpha <= 0) { particles.splice(i, 1); } else if (p.speed < 0.5 && p.word) { createExplosion(p.x, p.y, p.hue, p.word, p.scale); particles.splice(i, 1); } }
            }
            elements.tapCounter.textContent = 'Taps: 0';
            resizeHandlerV2();
            window.addEventListener('resize', resizeHandlerV2);
            fwCanvas.addEventListener('click', launchHandlerV2);
            elements.meaningBtn.addEventListener('click', meaningHandlerV2);
            animate();
        }
        function endSpecialModeV2(elements) {
            cancelAnimationFrame(fireworksAnimationIdV2);
            elements.specialModeV2.style.display = 'none';
            elements.container.style.display = 'block';
            window.removeEventListener('resize', resizeHandlerV2);
            elements.fireworksCanvasV2.removeEventListener('click', launchHandlerV2);
            elements.meaningBtn.removeEventListener('click', meaningHandlerV2);
            elements.meaningDisplay.classList.remove('show');
        }
        
        // ▼▼▼【新規追加】管理パネル用のJavaScript関数群 ▼▼▼
        function renderManagementWordList() {
            const container = document.getElementById('management-word-list-container');
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            
            const filteredWords = wordData.filter(word => 
                word.word.toLowerCase().includes(searchTerm) ||
                word.meaning.toLowerCase().includes(searchTerm)
            );

            container.innerHTML = '';
            if (filteredWords.length === 0) {
                container.innerHTML = '<p>該当する単語はありません。</p>';
                return;
            }

            const ul = document.createElement('ul');
            filteredWords.forEach(word => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <label>
                        <input type="checkbox" class="word-checkbox" data-id="${word.id}">
                        <strong>${word.word}</strong>: ${word.meaning}
                    </label>
                    <button class="delete-card-btn btn-danger" data-id="${word.id}">削除</button>
                `;
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }

        function addNewWord() {
            const wordInput = document.getElementById('add-word-input');
            const meaningInput = document.getElementById('add-meaning-input');
            const usageInput = document.getElementById('add-usage-input');
            const explanationInput = document.getElementById('add-explanation-input');

            const word = wordInput.value.trim();
            const meaning = meaningInput.value.trim();
            const usage = usageInput.value.trim();
            const explanation = explanationInput.value.trim();

            if (word && meaning && usage && explanation) {
                const newWord = {
                    id: Date.now(),
                    word,
                    meaning,
                    usage,
                    explanation
                };
                wordData.push(newWord);
                saveWordData();
                updateAllViews();
                
                wordInput.value = '';
                meaningInput.value = '';
                usageInput.value = '';
                explanationInput.value = '';

                alert('単語を追加しました。');
            } else {
                alert('すべての項目を入力してください。');
            }
        }
        
        function handleManagementListClick(e) {
            if (e.target.classList.contains('delete-card-btn')) {
                const wordId = Number(e.target.dataset.id);
                if (confirm('この単語を削除してもよろしいですか？')) {
                    wordData = wordData.filter(word => word.id !== wordId);
                    saveWordData();
                    updateAllViews();
                }
            }
        }
        
        function deleteSelectedWords() {
            const checkboxes = document.querySelectorAll('#management-word-list-container .word-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('削除する単語を選択してください。');
                return;
            }
            if (confirm(`${checkboxes.length}件の単語を削除してもよろしいですか？`)) {
                const idsToDelete = Array.from(checkboxes).map(cb => Number(cb.dataset.id));
                wordData = wordData.filter(word => !idsToDelete.includes(word.id));
                saveWordData();
                updateAllViews();
            }
        }

        function handleImport(fileInput) {
            if (fileInput.files.length === 0) {
                alert('ファイルを選択してください。');
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    const newWords = jsonData.map(row => ({
                        id: Date.now() + Math.random(),
                        word: row['英単語'] || row['word'],
                        meaning: row['主な意味'] || row['meaning'],
                        usage: row['用法'] || row['usage'],
                        explanation: row['解説'] || row['explanation']
                    })).filter(w => w.word && w.meaning && w.usage && w.explanation);

                    if (newWords.length > 0) {
                        wordData = wordData.concat(newWords);
                        saveWordData();
                        updateAllViews();
                        alert(`${newWords.length}件の単語をインポートしました。`);
                    } else {
                        alert('インポートできる有効なデータが見つかりませんでした。列名（英単語, 主な意味, 用法, 解説）が正しいか確認してください。');
                    }
                } catch (error) {
                    console.error("Import failed:", error);
                    alert("ファイルの読み込みに失敗しました。ファイル形式が正しいか確認してください。");
                }
            };
            reader.readAsBinaryString(file);
        }

        function exportToCsv() {
            const headers = "英単語,主な意味,用法,解説\n";
            const csvRows = wordData.map(w => `"${w.word}","${w.meaning}","${w.usage}","${w.explanation}"`);
            const csvContent = "data:text/csv;charset=utf-8," + headers + csvRows.join("\n");
            
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "word_list.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportToExcel() {
            const worksheetData = wordData.map(w => ({
                '英単語': w.word,
                '主な意味': w.meaning,
                '用法': w.usage,
                '解説': w.explanation
            }));
            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "単語一覧");
            XLSX.writeFile(workbook, "word_list.xlsx");
        }
        
        function downloadTemplate(content, fileName) {
            const link = document.createElement("a");
            const blob = new Blob([content], {type: 'text/plain'});
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadTemplateCsv(e) {
            e.preventDefault();
            const csvContent = "英単語,主な意味,用法,解説\n";
            downloadTemplate(csvContent, "単語帳インポート雛形.csv");
        }

        function downloadTemplateExcel(e) {
            e.preventDefault();
            const worksheet = XLSX.utils.json_to_sheet([{'英単語':'', '主な意味':'', '用法':'', '解説':'' }]);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "雛形");
            XLSX.writeFile(workbook, "単語帳インポート雛形.xlsx");
        }

    </script>
</body>
</html>
